import { useEffect, useRef, useState } from 'react';
import introVideo from '../assets/intro.mp4';

/*
  ══════════════════════════════════════════════════════
  BUGS FIXED vs previous version:
  ──────────────────────────────────────────────────────
  ✓ Duplicate <svg> stars block removed (was rendering 2×)
  ✓ Stars/fog rendered OUTSIDE the road conditional block — moved inside
  ✓ SVG logo position: left:'55%' → left:'50%' (was off-center)
  ✓ SVG logo transform on wrapper div conflicts with inner SVG transform
    → wrapper uses translate(-50%,-50%), inner SVG has NO extra transform
  ✓ Logo colour: #a855f7 → fill="#9810E8" with fillRule="evenodd"
    so inner sub-paths cut holes and show #4A0971 underneath
  ✓ svgReveal animation re-fires on every frame → only on frame 2
  ✓ video phase: onEnded never fires because it was missing on <video>
  ✓ Road scene stays visible during video → hidden when phase==='video'
  ✓ dark prop wired up (bg colour switches)
  ✓ Fade phase: onDone dep added to useEffect
  ✓ JSX structure closed correctly (was cut off before </div>)
  ══════════════════════════════════════════════════════
*/

type IntroLoaderProps = {
  onDone: () => void;
  dark: boolean;
};

// ── All 17 potrace frames (SVG path data) ─────────────────────────────────
// viewBox: 0 0 10800 19200  |  rendered with transform="translate(0,19200) scale(1,-1)"
// Outer shape → fill #9810E8  |  Inner cut-out holes → show #4A0971 behind (evenodd)
const FRAMES: string[] = [
  /* 00 */ '',
  /* 01 */ '',
  /* 02 */
  `<path d="M5135 11623 c-167 -42 -332 -112 -420 -178 -22 -16 -59 -43 -82 -58
-47 -33 -150 -137 -178 -182 -11 -16 -31 -46 -46 -65 -70 -90 -179 -361 -179
-442 0 -17 -7 -55 -16 -85 -19 -64 -17 -270 2 -294 7 -8 14 -42 16 -76 7 -99
-9 -94 292 -91 l261 3 6 103 c7 106 12 125 77 266 60 127 193 239 340 285 87
27 292 29 371 4 89 -28 167 -74 233 -138 74 -73 115 -135 156 -239 29 -70 32
-89 32 -182 l0 -104 263 0 c211 0 267 3 283 14 46 34 55 456 13 581 -6 17 -17
55 -25 85 -17 61 -46 129 -113 258 -26 50 -118 167 -185 234 -136 137 -339
243 -578 302 -90 22 -434 21 -523 -1z"/>`,
  /* 03 */
  `<path d="M5135 11623 c-167 -42 -332 -112 -420 -178 -22 -16 -59 -43 -82 -58
-47 -33 -150 -137 -178 -182 -11 -16 -31 -46 -46 -65 -67 -88 -179 -361 -179
-439 0 -14 -7 -51 -15 -81 -17 -62 -19 -193 -4 -260 5 -25 16 -79 24 -120 23
-123 33 -161 59 -235 14 -38 26 -76 26 -83 0 -18 142 -373 189 -475 21 -45 53
-113 71 -152 56 -121 217 -438 308 -605 60 -111 3 -100 513 -100 l447 0 28 48
c55 91 226 428 370 727 42 87 154 350 154 361 0 4 9 26 19 48 82 172 171 535
171 697 0 185 -44 365 -133 544 -158 316 -408 508 -784 604 -71 18 -110 21
-280 20 -141 -1 -215 -5 -258 -16z m450 -811 c186 -60 326 -204 395 -406 15
-47 20 -86 20 -175 0 -137 -15 -192 -82 -307 -77 -132 -187 -219 -347 -274
-81 -28 -252 -31 -334 -5 -174 54 -331 188 -389 330 -8 22 -24 59 -34 83 -13
33 -18 72 -18 170 -1 109 2 135 22 187 45 119 86 185 152 249 132 124 230 163
425 165 104 1 142 -2 190 -17z"/>
<path d="M7504 11158 c-37 -46 -111 -126 -164 -178 -53 -52 -121 -124 -150
-160 -30 -36 -85 -97 -123 -136 -64 -66 -77 -94 -43 -94 7 0 23 -11 36 -25 33
-35 56 -32 80 13 12 20 38 60 58 89 87 121 383 566 379 570 -3 2 -35 -33 -73
-79z"/>`,
  /* 04 */
  `<path d="M5135 11623 c-167 -42 -332 -112 -420 -178 -22 -16 -59 -43 -82 -58
-47 -33 -150 -137 -178 -182 -11 -16 -31 -46 -46 -65 -67 -88 -179 -361 -179
-439 0 -14 -7 -51 -15 -81 -39 -144 -1 -375 122 -750 23 -72 121 -312 182
-445 59 -131 300 -607 405 -800 83 -152 133 -242 296 -520 10 -16 50 -81 89
-144 39 -63 71 -118 71 -123 0 -20 32 -5 42 20 7 15 24 45 39 67 33 51 107
172 152 250 18 33 68 119 109 190 157 272 357 653 455 865 104 226 129 268
228 380 28 31 65 76 82 101 18 24 54 71 80 105 56 71 119 151 167 214 20 25
60 79 90 120 30 41 67 90 83 109 15 18 39 50 53 71 14 20 50 70 81 111 61 81
113 156 370 538 93 139 168 255 166 257 -3 3 -35 -32 -73 -78 -37 -45 -115
-130 -173 -188 -59 -58 -124 -129 -146 -158 -41 -54 -586 -594 -606 -601 -8
-2 -9 13 -5 50 36 301 3 514 -117 754 -158 317 -417 515 -788 604 -73 18 -117
21 -280 20 -137 -1 -212 -5 -254 -16z m450 -811 c186 -60 326 -204 395 -406
26 -77 28 -255 4 -337 -59 -199 -202 -346 -409 -418 -78 -28 -260 -31 -338 -6
-179 57 -330 185 -389 330 -8 22 -24 60 -34 84 -29 69 -27 275 4 356 45 119
86 185 152 249 132 124 230 163 425 165 104 1 142 -2 190 -17z"/>`,
  /* 05 */
  `<path d="M5135 11623 c-167 -42 -332 -112 -420 -178 -22 -16 -59 -43 -82 -58
-47 -33 -150 -137 -178 -182 -11 -16 -31 -46 -46 -65 -67 -88 -179 -361 -179
-439 0 -14 -7 -51 -15 -81 -17 -62 -19 -193 -4 -260 5 -25 16 -79 24 -120 23
-123 33 -161 59 -235 14 -38 26 -76 26 -83 0 -20 104 -285 162 -412 16 -36 33
-74 38 -85 24 -57 224 -461 264 -534 25 -47 46 -86 46 -87 0 -1 -17 -12 -37
-25 -21 -12 -49 -32 -63 -45 -14 -13 -60 -39 -103 -58 -66 -31 -89 -36 -149
-36 -39 0 -95 7 -124 16 -28 10 -58 14 -66 11 -30 -11 -51 -96 -49 -196 3
-102 13 -134 75 -236 43 -71 59 -84 154 -130 89 -43 139 -45 250 -10 89 28
297 131 343 169 17 14 36 26 42 26 7 0 32 -37 57 -82 25 -44 84 -144 133 -221
48 -77 87 -144 87 -148 0 -21 31 -7 42 19 7 15 21 40 33 57 18 27 141 233 189
316 11 19 50 86 86 150 102 175 239 427 320 589 40 80 76 150 81 156 5 6 15
28 23 50 27 77 126 272 163 324 21 29 61 79 88 110 28 31 65 76 82 101 18 24
54 71 80 105 56 71 119 151 167 214 20 25 60 79 90 120 30 41 67 90 83 109 15
18 39 50 53 71 14 20 50 70 81 111 61 81 113 156 370 538 93 139 168 255 166
257 -3 3 -35 -32 -73 -78 -37 -45 -115 -130 -173 -188 -59 -58 -124 -129 -146
-158 -41 -54 -586 -594 -606 -601 -8 -2 -9 13 -5 50 36 301 3 514 -117 754
-158 317 -417 515 -788 604 -73 18 -117 21 -280 20 -137 -1 -212 -5 -254 -16z
m450 -811 c186 -60 326 -204 395 -406 27 -80 28 -254 2 -341 -58 -196 -201
-342 -407 -414 -78 -28 -260 -31 -338 -6 -179 57 -330 185 -389 330 -8 22 -24
60 -34 84 -29 69 -27 275 4 356 45 119 86 185 152 249 132 124 230 163 425
165 104 1 142 -2 190 -17z"/>`,
  /* 06 */
  `<path d="M5135 11623 c-167 -42 -332 -112 -420 -178 -22 -16 -59 -43 -82 -58
-47 -33 -150 -137 -178 -182 -11 -16 -31 -46 -46 -65 -67 -88 -179 -361 -179
-439 0 -14 -7 -51 -15 -81 -21 -77 -19 -202 5 -317 11 -54 25 -123 31 -153 6
-30 17 -71 24 -90 8 -19 17 -46 20 -60 3 -14 10 -34 14 -45 4 -11 16 -45 25
-75 34 -109 159 -405 257 -608 44 -90 77 -168 73 -173 -3 -5 -11 -9 -17 -9
-18 0 -271 -257 -310 -315 -19 -28 -51 -88 -71 -134 -31 -74 -36 -95 -36 -164
0 -74 3 -86 46 -174 57 -116 90 -150 189 -197 96 -46 145 -47 268 -5 97 32
283 125 330 165 16 13 34 24 40 24 7 0 32 -37 57 -82 25 -44 84 -144 133 -221
48 -77 87 -144 87 -148 0 -21 31 -7 42 19 7 15 21 40 33 57 18 27 141 233 189
316 11 19 50 86 86 150 102 175 239 427 320 589 40 80 76 150 81 156 5 6 15
28 23 50 27 77 126 272 163 324 21 29 61 79 88 110 28 31 65 76 82 101 18 24
54 71 80 105 27 33 67 85 90 115 23 30 58 74 78 99 33 42 47 61 135 180 19 26
47 63 61 81 70 92 174 235 238 329 243 359 412 613 408 616 -3 3 -35 -32 -73
-78 -37 -46 -111 -126 -164 -178 -53 -52 -118 -122 -144 -155 -54 -67 -605
-615 -619 -615 -5 0 -6 23 -3 53 36 298 3 512 -117 752 -158 317 -417 515
-788 604 -73 18 -117 21 -280 20 -137 -1 -212 -5 -254 -16z m450 -811 c186
-60 326 -204 395 -406 27 -80 28 -254 2 -341 -58 -196 -200 -341 -407 -415
-78 -27 -258 -30 -338 -5 -148 47 -269 136 -351 258 -43 63 -34 73 29 37 30
-17 65 -30 77 -28 32 4 35 36 5 47 -27 10 -72 61 -82 91 -9 27 -19 25 -49 -10
l-25 -31 -23 43 c-20 38 -22 58 -23 173 0 112 3 139 23 190 45 119 86 185 152
249 132 124 230 163 425 165 104 1 142 -2 190 -17z m-804 -1919 c12 -27 29
-56 37 -66 19 -21 15 -25 -63 -66 -69 -36 -135 -42 -135 -13 0 19 116 192 130
192 4 0 18 -21 31 -47z"/>`,
  /* 07 */
  `<path d="M5135 11623 c-167 -42 -332 -112 -420 -178 -22 -16 -58 -42 -80 -57
-178 -121 -365 -439 -404 -688 -6 -36 -15 -81 -21 -100 -13 -44 -13 -193 0
-245 6 -22 17 -76 25 -120 22 -122 40 -189 74 -280 4 -11 16 -45 25 -75 34
-109 159 -404 257 -608 44 -90 77 -168 74 -173 -4 -5 -12 -9 -18 -9 -18 0
-271 -257 -310 -315 -19 -28 -51 -88 -71 -134 -31 -74 -36 -95 -36 -164 0 -74
3 -86 46 -174 57 -116 90 -150 189 -197 100 -47 145 -47 284 0 58 20 111 40
116 44 6 4 46 27 90 50 44 24 93 54 109 67 16 13 34 22 40 20 6 -2 33 -41 60
-88 27 -46 87 -144 133 -218 45 -73 83 -138 83 -142 0 -21 32 -7 43 19 7 15
48 86 93 157 45 72 93 153 108 180 15 28 52 93 83 145 161 276 360 652 477
905 95 204 135 270 214 356 24 26 60 70 80 98 67 90 149 195 181 231 17 19 31
38 31 42 0 4 14 24 32 44 17 19 49 59 69 87 70 95 119 161 169 227 168 223
627 897 617 907 -3 2 -26 -22 -52 -54 -26 -32 -99 -112 -164 -178 -64 -66
-138 -147 -165 -180 -54 -67 -605 -615 -619 -615 -5 0 -6 26 -2 58 20 185 14
365 -16 472 -6 19 -19 65 -29 101 -11 37 -43 113 -71 170 -161 323 -417 518
-801 613 -90 22 -434 21 -523 -1z m450 -811 c184 -58 326 -204 395 -406 26
-77 28 -255 4 -337 -59 -199 -201 -345 -409 -419 -80 -28 -255 -30 -342 -4
-139 43 -266 136 -348 258 -42 62 -32 70 36 31 24 -14 51 -25 60 -25 19 0 124
107 165 169 72 109 85 129 109 173 38 71 75 194 75 249 0 93 -66 220 -136 261
-18 11 -34 25 -34 32 0 19 90 32 235 34 105 2 142 -1 190 -16z m-518 -107 c47
-33 63 -76 63 -173 0 -89 -1 -93 -48 -184 -66 -130 -213 -328 -243 -328 -42 0
-62 293 -26 380 70 169 114 237 192 298 33 26 34 26 62 7z m-288 -1807 c13
-29 31 -61 39 -71 19 -21 15 -25 -63 -66 -70 -36 -135 -42 -135 -12 0 10 11
33 24 52 14 19 42 60 62 92 20 31 40 57 43 57 3 0 17 -24 30 -52z"/>`,
  /* 08 */
  `<path d="M5165 11629 c-16 -5 -51 -14 -78 -19 -164 -33 -418 -174 -545 -303
-101 -102 -193 -249 -249 -394 -49 -129 -63 -176 -63 -215 0 -33 -4 -40 -32
-53 -85 -39 -338 -209 -338 -227 0 -23 38 -13 160 43 74 34 144 62 155 63 18
1 21 -7 26 -95 4 -53 11 -104 16 -115 6 -10 13 -43 17 -73 9 -69 45 -205 75
-286 4 -11 16 -45 25 -75 15 -50 34 -100 57 -155 4 -11 20 -49 34 -85 14 -36
37 -89 51 -118 13 -29 24 -55 24 -57 0 -3 38 -84 85 -181 47 -96 83 -180 80
-185 -4 -5 -12 -9 -18 -9 -18 0 -271 -257 -310 -315 -19 -28 -51 -88 -71 -134
-63 -148 -48 -265 57 -421 40 -59 49 -67 145 -115 52 -26 83 -35 120 -35 62 0
198 40 272 79 135 72 180 98 204 118 16 13 33 22 39 20 9 -3 117 -172 117
-182 0 -1 36 -60 80 -130 44 -70 80 -132 80 -136 0 -21 32 -7 43 19 7 15 48
86 93 157 45 72 93 153 108 180 15 28 52 93 83 145 161 276 360 652 477 905
95 204 135 270 214 356 24 26 60 70 80 98 67 90 149 195 181 231 17 19 31 38
31 42 0 4 14 24 32 44 17 19 49 59 69 87 70 95 119 161 169 227 168 223 627
897 617 907 -3 2 -26 -22 -52 -54 -26 -32 -99 -112 -164 -178 -64 -66 -138
-147 -165 -180 -54 -67 -605 -615 -619 -615 -5 0 -6 26 -2 58 20 185 14 365
-16 472 -6 19 -19 65 -29 101 -11 37 -43 113 -71 170 -161 323 -417 518 -801
613 -51 12 -112 16 -265 15 -109 0 -211 -5 -228 -10z m420 -817 c184 -58 326
-204 395 -406 26 -77 28 -255 4 -337 -59 -199 -201 -345 -409 -419 -80 -28
-255 -30 -342 -4 -139 43 -266 136 -348 258 -42 62 -32 70 36 31 24 -14 51
-25 60 -25 19 0 124 107 165 169 16 24 41 62 57 85 41 62 93 174 112 243 24
85 17 155 -23 236 -28 57 -50 82 -119 138 -7 5 -13 13 -13 18 0 14 103 27 235
29 105 2 142 -1 190 -16z m-518 -107 c47 -33 63 -76 63 -173 0 -89 -1 -93 -48
-184 -66 -130 -213 -328 -243 -328 -5 0 -16 17 -25 38 -12 27 -17 72 -18 167
-1 113 2 138 21 187 55 140 111 225 187 286 34 26 35 26 63 7z m-288 -1807
c13 -29 31 -61 39 -71 19 -21 15 -25 -63 -66 -70 -36 -135 -42 -135 -12 0 10
11 33 24 52 14 19 42 60 62 92 20 31 40 57 43 57 3 0 17 -24 30 -52z"/>`,
  /* 09 */
  `<path d="M5165 11629 c-16 -5 -51 -14 -78 -19 -164 -33 -418 -174 -545 -303
-101 -102 -193 -249 -249 -394 -49 -129 -63 -176 -63 -216 0 -27 -5 -39 -17
-44 -48 -17 -462 -289 -463 -304 0 -7 84 28 300 125 69 31 131 56 137 56 9 0
13 -21 13 -72 0 -40 5 -91 11 -113 6 -22 17 -74 24 -115 21 -109 55 -234 76
-272 5 -10 9 -26 9 -37 0 -16 39 -125 70 -196 5 -11 21 -49 35 -85 14 -36 37
-89 51 -118 13 -29 24 -55 24 -57 0 -3 38 -84 85 -181 47 -96 83 -180 80 -185
-4 -5 -12 -9 -18 -9 -18 0 -271 -257 -310 -315 -19 -28 -51 -88 -71 -134 -31
-74 -36 -95 -36 -163 0 -87 24 -153 93 -256 40 -62 49 -68 145 -117 52 -26 83
-35 120 -35 62 0 201 40 273 80 9 5 52 28 95 51 44 23 92 53 108 66 16 13 33
22 39 20 9 -3 117 -172 117 -182 0 -1 36 -60 80 -130 44 -70 80 -132 80 -136
0 -21 32 -7 43 19 7 15 48 86 93 157 45 72 93 153 108 180 15 28 52 93 83 145
161 276 360 652 477 905 95 204 135 270 214 356 24 26 60 70 80 98 67 90 149
195 181 231 17 19 31 38 31 42 0 4 14 24 32 44 17 19 49 59 69 87 70 95 119
161 169 227 168 223 627 897 617 907 -3 2 -26 -22 -52 -54 -26 -32 -99 -112
-164 -178 -64 -66 -138 -147 -165 -180 -54 -67 -605 -615 -619 -615 -5 0 -6
26 -2 58 21 191 13 388 -20 487 -7 22 -21 66 -29 97 -9 32 -40 104 -68 160
-102 205 -246 361 -433 469 -70 41 -213 103 -270 118 -22 5 -67 17 -101 25
-69 18 -436 22 -489 5z m415 -815 c92 -27 164 -72 250 -156 54 -52 96 -118
136 -213 25 -62 29 -85 32 -192 3 -93 0 -136 -13 -180 -59 -202 -201 -348
-410 -423 -80 -28 -255 -30 -342 -4 -139 43 -266 136 -348 258 -42 62 -32 70
36 31 24 -14 51 -25 60 -25 19 0 125 110 167 172 15 22 39 59 55 82 41 62 93
174 112 243 24 85 17 155 -23 236 -28 57 -50 82 -119 138 -7 5 -13 13 -13 18
0 29 333 41 420 15z m-513 -109 c48 -34 63 -76 63 -176 0 -93 -1 -95 -49 -185
-70 -133 -213 -324 -242 -324 -5 0 -16 17 -25 38 -12 27 -17 72 -18 167 -1
113 2 138 21 187 55 140 111 225 187 286 34 26 35 26 63 7z m-287 -1811 c14
-31 31 -60 37 -66 22 -18 15 -25 -52 -62 -76 -42 -145 -50 -145 -17 0 10 11
33 24 52 14 19 42 60 62 92 20 31 40 57 43 57 4 0 18 -25 31 -56z"/>`,
  /* 10 */
  `<path d="M5135 11623 c-167 -42 -332 -112 -420 -178 -22 -16 -58 -42 -80 -57
-89 -60 -204 -199 -278 -335 -59 -108 -127 -298 -127 -356 0 -27 -5 -39 -17
-44 -49 -17 -462 -289 -463 -304 0 -7 84 28 300 125 69 31 131 56 137 56 9 0
13 -20 13 -67 1 -38 5 -88 11 -113 5 -25 14 -70 20 -100 11 -64 37 -173 48
-204 5 -11 16 -48 26 -81 16 -56 66 -196 85 -240 5 -11 34 -81 66 -155 31 -74
92 -208 136 -298 75 -154 83 -182 55 -182 -18 0 -271 -257 -310 -315 -19 -28
-51 -88 -71 -134 -32 -74 -36 -94 -36 -165 0 -76 3 -86 47 -175 56 -113 86
-145 186 -193 108 -54 187 -50 342 17 17 7 35 14 40 16 25 9 202 112 227 130
14 12 31 19 36 15 9 -5 75 -113 117 -191 21 -39 70 -110 78 -113 4 -2 7 -8 7
-13 0 -15 81 -139 91 -139 5 0 15 12 22 28 6 15 35 63 63 108 50 78 85 136
239 404 77 134 239 430 271 495 11 22 50 99 86 170 36 72 82 166 103 210 99
211 129 262 220 366 49 57 94 113 166 210 20 26 52 67 72 91 20 24 46 57 59
74 13 18 39 53 58 79 19 27 50 66 69 89 19 23 44 57 58 76 13 19 46 64 73 100
27 36 70 94 95 130 25 36 79 112 120 170 72 103 221 323 344 509 34 51 60 95
58 98 -3 2 -26 -22 -52 -54 -26 -32 -100 -112 -164 -178 -64 -66 -139 -147
-165 -180 -56 -68 -605 -615 -619 -615 -5 0 -6 26 -3 58 22 204 14 387 -19
487 -7 22 -21 66 -29 97 -22 77 -109 249 -163 323 -171 231 -412 384 -710 449
-98 22 -431 21 -518 -1z m445 -809 c171 -51 309 -183 386 -369 25 -61 29 -86
32 -190 3 -90 0 -135 -13 -182 -53 -197 -204 -351 -413 -423 -84 -29 -250 -31
-338 -4 -140 43 -266 136 -349 258 -42 62 -32 70 36 31 24 -14 51 -25 60 -25
19 0 125 110 167 172 15 22 39 59 55 82 41 62 93 174 112 243 24 85 17 155
-23 236 -28 57 -50 82 -119 138 -7 5 -13 13 -13 18 0 29 333 41 420 15z m-513
-109 c47 -33 63 -76 63 -173 0 -89 -1 -93 -48 -184 -66 -130 -213 -328 -243
-328 -42 0 -62 292 -26 380 65 160 119 244 191 298 35 26 36 26 63 7z m-287
-1811 c14 -31 31 -60 37 -66 22 -18 15 -25 -52 -62 -76 -42 -145 -50 -145 -17
0 10 11 33 24 52 14 19 42 60 62 92 20 31 40 57 43 57 4 0 18 -25 31 -56z"/>`,
  /* 11 */
  `<path d="M5135 11623 c-167 -42 -332 -112 -420 -178 -22 -16 -58 -42 -80 -57
-89 -60 -204 -199 -278 -335 -59 -108 -127 -298 -127 -356 0 -27 -5 -39 -17
-44 -49 -17 -462 -289 -463 -304 0 -7 84 28 300 125 69 31 131 56 137 56 9 0
13 -20 13 -67 1 -38 5 -88 11 -113 5 -25 14 -70 20 -100 11 -64 37 -173 48
-204 5 -11 16 -48 26 -81 16 -56 66 -196 85 -240 5 -11 34 -81 66 -155 31 -74
92 -208 136 -298 75 -154 83 -182 55 -182 -18 0 -271 -257 -310 -315 -19 -28
-51 -88 -71 -134 -32 -74 -36 -94 -36 -165 0 -76 3 -86 47 -175 56 -113 86
-145 186 -193 108 -54 187 -50 342 17 17 7 35 14 40 16 25 9 202 112 227 130
14 12 31 19 36 15 9 -5 75 -113 117 -191 21 -39 70 -110 78 -113 4 -2 7 -8 7
-13 0 -15 81 -139 91 -139 5 0 15 12 22 28 6 15 35 63 63 108 50 78 85 136
239 404 77 134 239 430 271 495 11 22 50 99 86 170 36 72 82 166 103 210 99
211 129 262 220 366 48 55 64 76 182 231 29 38 64 81 78 96 14 15 25 30 25 34
0 4 17 27 38 51 20 24 53 65 72 92 19 26 54 73 77 104 91 119 135 181 284 391
140 198 245 353 252 373 8 21 -1 47 -17 47 -15 0 -131 -119 -200 -205 -56 -69
-605 -615 -619 -615 -5 0 -6 26 -3 58 22 204 14 387 -19 487 -7 22 -21 66 -29
97 -22 77 -109 249 -163 323 -171 231 -412 384 -710 449 -98 22 -431 21 -518
-1z m445 -809 c171 -51 309 -183 386 -369 25 -61 29 -86 32 -190 3 -90 0 -135
-13 -182 -53 -197 -204 -351 -413 -423 -84 -29 -250 -31 -338 -4 -140 43 -266
136 -349 258 -42 62 -32 70 36 31 24 -14 51 -25 60 -25 19 0 125 110 167 172
15 22 39 59 55 82 41 62 93 174 112 243 24 85 17 155 -23 236 -28 57 -50 82
-119 138 -7 5 -13 13 -13 18 0 29 333 41 420 15z m-513 -109 c47 -33 63 -76
63 -173 0 -89 -1 -93 -48 -184 -66 -130 -213 -328 -243 -328 -42 0 -62 292
-26 380 65 160 119 244 191 298 35 26 36 26 63 7z m-287 -1811 c14 -31 31 -60
37 -66 22 -18 15 -25 -52 -62 -76 -42 -145 -50 -145 -17 0 10 11 33 24 52 14
19 42 60 62 92 20 31 40 57 43 57 4 0 18 -25 31 -56z"/>`,
  /* 12 */
  `<path d="M5135 11623 c-167 -42 -332 -112 -420 -178 -22 -16 -58 -42 -80 -57
-89 -60 -204 -199 -278 -335 -59 -108 -127 -298 -127 -356 0 -27 -5 -39 -17
-44 -49 -17 -462 -289 -463 -304 0 -7 84 28 300 125 69 31 131 56 137 56 9 0
13 -20 13 -67 1 -38 5 -88 11 -113 5 -25 14 -70 20 -100 11 -64 37 -173 48
-204 5 -11 16 -48 26 -81 16 -56 66 -196 85 -240 5 -11 34 -81 66 -155 31 -74
92 -208 136 -298 75 -154 83 -182 55 -182 -18 0 -271 -257 -310 -315 -19 -28
-51 -88 -71 -134 -31 -74 -36 -95 -36 -165 0 -72 4 -87 39 -160 54 -111 102
-163 194 -208 108 -54 187 -50 342 17 17 7 35 14 40 16 25 9 202 112 227 130
14 12 31 19 36 15 9 -5 75 -113 117 -191 21 -39 70 -110 78 -113 4 -2 7 -8 7
-13 0 -15 81 -139 91 -139 5 0 15 12 22 28 6 15 35 63 63 108 29 44 78 125
109 180 32 54 80 137 108 184 157 269 506 943 597 1150 13 30 34 80 48 110 57
132 149 388 173 485 10 44 24 88 30 98 12 22 29 139 36 257 6 93 -11 261 -32
325 -7 22 -21 66 -29 97 -22 77 -109 249 -163 323 -173 234 -409 383 -710 449
-98 22 -431 21 -518 -1z m445 -809 c119 -35 255 -139 325 -249 18 -27 45 -81
61 -120 25 -61 29 -86 32 -190 4 -140 -11 -210 -67 -314 -46 -84 -158 -197
-236 -238 -113 -59 -175 -75 -294 -75 -119 0 -188 16 -281 65 -139 74 -231
177 -290 326 -31 76 -33 90 -34 209 -1 138 0 142 71 292 38 79 85 139 139 178
39 29 61 21 99 -36 22 -32 25 -47 25 -127 0 -85 -2 -96 -39 -171 -44 -91 -112
-195 -182 -276 -27 -31 -49 -63 -49 -70 0 -22 77 -97 107 -104 23 -6 34 1 90
59 34 37 75 85 90 108 16 23 40 60 56 83 41 62 93 174 112 243 24 85 17 155
-23 236 -28 57 -50 82 -119 138 -7 5 -13 13 -13 18 0 29 333 41 420 15z m-800
-1920 c14 -31 31 -60 37 -66 22 -18 15 -25 -52 -62 -76 -42 -145 -50 -145 -17
0 10 11 33 24 52 14 19 42 60 62 92 20 31 40 57 43 57 4 0 18 -25 31 -56z"/>`,
  /* 13 */
  `<path d="M5135 11623 c-167 -42 -333 -112 -420 -178 -22 -17 -52 -38 -67 -48
-90 -57 -205 -193 -288 -340 -59 -104 -130 -300 -130 -360 0 -27 -5 -39 -17
-44 -49 -17 -462 -289 -463 -304 0 -7 84 28 300 125 69 31 131 56 137 56 9 0
13 -20 13 -67 1 -38 5 -88 11 -113 5 -25 14 -70 20 -100 11 -64 37 -173 48
-204 5 -11 16 -48 26 -81 16 -56 66 -196 85 -240 5 -11 34 -81 66 -155 31 -74
92 -208 136 -298 75 -154 83 -182 55 -182 -18 0 -271 -257 -310 -315 -19 -28
-51 -88 -71 -134 -31 -73 -36 -95 -36 -162 0 -61 5 -89 26 -135 43 -99 93
-174 115 -174 11 0 44 18 73 39 77 57 130 147 142 244 4 29 22 96 41 150 39
115 39 123 13 130 -11 3 -20 12 -20 19 0 16 119 198 129 198 4 0 17 -24 31
-52 30 -64 212 -403 259 -483 33 -55 164 -280 182 -312 21 -37 71 -116 79
-123 6 -6 46 -76 67 -117 20 -40 39 -42 56 -5 6 15 35 63 63 108 29 44 78 125
109 180 32 54 83 142 113 194 186 318 334 602 520 990 104 218 127 270 174
395 71 188 100 275 119 350 10 44 24 88 30 98 12 22 29 139 36 257 6 93 -11
261 -32 325 -7 22 -21 66 -29 97 -22 77 -109 249 -163 323 -173 234 -409 383
-710 449 -98 22 -431 21 -518 -1z m456 -812 c169 -58 301 -188 375 -366 25
-61 29 -86 32 -189 4 -138 -9 -201 -66 -310 -70 -134 -190 -234 -348 -292 -89
-33 -257 -36 -350 -8 -111 34 -208 95 -289 183 -57 62 -78 95 -114 186 -29 70
-33 95 -38 205 -5 115 -4 129 16 167 11 23 21 48 21 54 0 24 73 154 108 194
39 44 90 85 105 85 21 0 87 -84 87 -109 0 -14 3 -43 6 -63 7 -38 7 -38 54 -38
43 0 51 4 84 40 20 22 36 45 36 50 0 39 -76 142 -122 166 -16 8 -27 21 -25 27
12 36 337 50 428 18z"/>`,
  /* 14 */
  `<path d="M5135 11623 c-167 -42 -333 -112 -420 -178 -22 -17 -52 -38 -67 -48
-90 -57 -205 -193 -288 -340 -59 -104 -130 -300 -130 -360 0 -27 -5 -39 -17
-44 -49 -17 -462 -289 -463 -304 0 -7 84 28 300 125 69 31 131 56 137 56 9 0
13 -20 13 -67 1 -38 5 -88 11 -113 5 -25 14 -70 19 -100 34 -196 158 -545 303
-855 59 -125 287 -580 337 -670 18 -33 59 -109 92 -170 32 -60 67 -123 77
-140 29 -49 162 -277 182 -312 21 -37 71 -116 79 -123 6 -6 46 -76 67 -117 20
-40 40 -42 56 -5 7 15 48 84 92 155 44 70 92 149 106 175 14 26 52 92 84 147
181 309 335 602 523 995 104 218 127 270 174 395 71 188 100 275 119 350 10
44 24 88 30 98 12 22 29 139 36 257 6 93 -11 261 -32 325 -7 22 -21 66 -29 97
-22 77 -109 249 -163 323 -173 234 -409 383 -710 449 -98 22 -431 21 -518 -1z
m443 -808 c119 -36 256 -141 327 -250 18 -27 45 -81 61 -120 25 -61 29 -86 32
-189 4 -138 -9 -201 -66 -310 -70 -134 -190 -234 -348 -292 -89 -33 -257 -36
-350 -8 -111 34 -208 95 -289 183 -57 62 -78 96 -114 185 -27 68 -32 96 -37
195 -5 107 -4 122 21 196 65 198 200 339 385 402 54 19 87 23 196 23 88 0 147
-5 182 -15z"/>`,
  /* 15 */
  `<path d="M5135 11623 c-171 -43 -333 -113 -433 -186 -136 -99 -191 -153 -263
-254 -105 -146 -187 -338 -205 -478 -3 -22 -11 -60 -18 -85 -17 -58 -20 -201
-6 -265 6 -27 17 -84 25 -125 21 -113 25 -127 106 -370 27 -83 134 -340 192
-465 59 -125 287 -580 337 -670 18 -33 59 -109 92 -170 32 -60 67 -123 77
-140 29 -49 162 -277 182 -312 21 -37 71 -116 79 -123 6 -6 46 -76 67 -117 20
-40 40 -42 56 -5 7 15 48 84 92 155 44 70 92 149 106 175 14 26 52 92 84 147
181 309 335 602 523 995 104 218 127 270 174 395 71 188 100 275 119 350 10
44 24 88 30 98 12 22 29 139 36 257 6 93 -11 261 -32 325 -7 22 -21 66 -29 97
-22 77 -109 249 -163 323 -173 234 -409 383 -710 449 -98 22 -431 21 -518 -1z
m443 -808 c119 -36 256 -141 327 -250 18 -27 45 -81 61 -120 25 -61 29 -86 32
-189 4 -138 -9 -201 -66 -310 -70 -134 -190 -234 -348 -292 -89 -33 -257 -36
-350 -8 -111 34 -208 95 -289 183 -57 62 -78 96 -113 184 -26 64 -32 97 -38
190 -7 113 -5 128 33 232 49 135 145 254 260 322 96 56 165 72 309 73 88 0
147 -5 182 -15z"/>`,
  /* 16 */
  `<path d="M5135 11623 c-316 -82 -544 -226 -696 -439 -144 -202 -215 -419 -226
-686 -3 -75 -1 -118 6 -118 5 0 13 21 16 48 9 63 62 235 93 297 66 135 142
239 256 350 61 59 214 175 232 175 3 0 18 8 32 19 44 30 190 80 347 117 108
26 311 26 410 0 39 -9 90 -22 115 -28 64 -16 202 -73 263 -110 46 -28 123 -83
137 -98 3 -3 29 -25 58 -49 75 -62 242 -270 242 -302 0 -4 14 -31 30 -59 17
-28 30 -54 30 -57 0 -4 12 -35 26 -71 14 -35 31 -96 39 -135 8 -40 18 -83 23
-97 l9 -25 7 23 c15 45 -14 311 -44 423 -105 382 -395 680 -770 791 -30 9 -73
22 -95 29 -24 7 -130 13 -260 15 -176 2 -232 0 -280 -13z"/>
<path d="M6215 9392 c-122 -114 -222 -180 -356 -235 -293 -120 -550 -129 -845
-31 -128 43 -234 100 -329 180 -27 22 -65 49 -82 58 -18 9 -33 20 -33 24 0 4
-9 13 -20 20 -19 12 -19 11 1 -41 49 -125 378 -767 488 -952 30 -51 163 -278
182 -312 21 -37 71 -116 79 -123 6 -6 46 -76 67 -117 20 -40 40 -42 56 -5 7
15 48 84 92 155 44 70 92 149 106 175 14 26 52 92 84 147 64 109 168 293 223
395 79 147 282 555 293 589 6 20 20 51 31 69 32 52 17 54 -37 4z"/>`,
  /* 17-21 */ '', '', '', '', '',
];

const FRAME_MS = 110;
const HOLD_MS  = 900;
const FADE_MS  = 700;

// Stable star data — generated once at module level, NOT inside component
const STARS = Array.from({ length: 60 }, () => ({
  x:     Math.random() * 100,
  y:     Math.random() * 55,
  r:     Math.random() * 1.4 + 0.3,
  delay: Math.random() * 5,
  dur:   Math.random() * 3 + 2,
}));

export default function IntroLoader({ onDone, dark }: IntroLoaderProps) {
  const [phase, setPhase]     = useState<'road' | 'svg' | 'video' | 'fade'>('road');
  const [frame, setFrame]     = useState(0);
  const [opacity, setOpacity] = useState(1);
  const videoRef              = useRef<HTMLVideoElement>(null);

  // ── Phase 1 › road → svg after 1.8s ─────────────────────────────────────
  useEffect(() => {
    const t = setTimeout(() => {
      setPhase('svg');
      setFrame(2); // first real potrace frame
    }, 1800);
    return () => clearTimeout(t);
  }, []);

  // ── Phase 2 › step SVG frames ────────────────────────────────────────────
  useEffect(() => {
    if (phase !== 'svg') return;
    if (frame >= FRAMES.length - 1) {
      setPhase('video');
      return;
    }
    const dur = frame === 15 ? HOLD_MS : FRAME_MS;
    const t = setTimeout(() => setFrame(f => f + 1), dur);
    return () => clearTimeout(t);
  }, [phase, frame]);

  // ── Phase 3 › play intro video ───────────────────────────────────────────
  useEffect(() => {
    if (phase !== 'video') return;
    const vid = videoRef.current;
    if (!vid) {
      setPhase('fade');
      return;
    }
    vid.currentTime = 0;
    vid.play().catch(() => setPhase('fade'));
    // onEnded is wired via JSX prop below — triggers setPhase('fade')
  }, [phase]);

  // ── Phase 4 › fade out ───────────────────────────────────────────────────
  useEffect(() => {
    if (phase !== 'fade') return;
    setOpacity(0);
    const t = setTimeout(onDone, FADE_MS);
    return () => clearTimeout(t);
  }, [phase, onDone]);

  const isRoad  = phase === 'road';
  const isSvg   = phase === 'svg';
  const isVideo = phase === 'video';

  return (
    <div
      style={{
        position: 'fixed',
        inset: 0,
        backgroundColor: dark ? '#03010a' : '#0a0015',
        opacity,
        transition: `opacity ${FADE_MS}ms ease`,
        zIndex: 9999,
        overflow: 'hidden',
      }}
    >
      <style>{`
        @keyframes roadScroll {
          from { transform: translateY(0); }
          to   { transform: translateY(60px); }
        }
        @keyframes twinkle {
          0%, 100% { opacity: 0.15; }
          50%      { opacity: 1; }
        }
        @keyframes horizonBreath {
          from { opacity: 0.45; transform: translate(-50%, -50%) scale(0.88); }
          to   { opacity: 1;   transform: translate(-50%, -50%) scale(1.12); }
        }
        @keyframes svgRevealIn {
          from { opacity: 0; transform: translate(-50%, -50%) scale(0.82); }
          to   { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        @keyframes videoRevealIn {
          from { opacity: 0; }
          to   { opacity: 1; }
        }
      `}</style>

      {/* ════════════════════════════════════════
          ROAD SCENE — visible during road + svg
      ════════════════════════════════════════ */}
      {(isRoad || isSvg) && (
        <>
          {/* Stars — ONE svg block only */}
          <svg
            style={{
              position: 'absolute', inset: 0,
              width: '100%', height: '100%',
              zIndex: 1, pointerEvents: 'none',
            }}
          >
            {STARS.map((s, i) => (
              <circle
                key={i}
                cx={`${s.x}%`}
                cy={`${s.y}%`}
                r={s.r}
                fill="white"
                style={{
                  animation: `twinkle ${s.dur}s ${s.delay}s ease-in-out infinite`,
                }}
              />
            ))}
          </svg>

          {/* Atmospheric fog */}
          <div
            style={{
              position: 'absolute', inset: 0,
              zIndex: 2, pointerEvents: 'none',
              background:
                'radial-gradient(ellipse at 50% 55%, rgba(100,30,210,0.09), transparent 68%)',
            }}
          />

          {/* Perspective road */}
          <svg
            viewBox="0 0 800 450"
            preserveAspectRatio="xMidYMax meet"
            style={{
              position: 'absolute', bottom: 0, left: 0,
              width: '100%', height: '100%',
              zIndex: 3, pointerEvents: 'none',
            }}
          >
            <defs>
              <linearGradient id="il-rg" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%"   stopColor="#0e001f" />
                <stop offset="100%" stopColor="#1c0038" />
              </linearGradient>
              <linearGradient id="il-el" x1="0" y1="0" x2="1" y2="0">
                <stop offset="0%"   stopColor="#a855f7" stopOpacity="0.6" />
                <stop offset="100%" stopColor="#a855f7" stopOpacity="0" />
              </linearGradient>
              <linearGradient id="il-er" x1="1" y1="0" x2="0" y2="0">
                <stop offset="0%"   stopColor="#a855f7" stopOpacity="0.6" />
                <stop offset="100%" stopColor="#a855f7" stopOpacity="0" />
              </linearGradient>
              <radialGradient id="il-hg" cx="50%" cy="0%" r="50%">
                <stop offset="0%"   stopColor="#7700dd" stopOpacity="0.5" />
                <stop offset="100%" stopColor="transparent" />
              </radialGradient>
              <linearGradient id="il-rf" x1="0" y1="1" x2="0" y2="0">
                <stop offset="0%"   stopColor="#1c0038" stopOpacity="0" />
                <stop offset="60%"  stopColor="#03010a"  stopOpacity="0.6" />
              </linearGradient>
              <clipPath id="il-rc">
                <polygon points="382,0 418,0 800,450 0,450" />
              </clipPath>
            </defs>

            <polygon points="382,0 418,0 800,450 0,450" fill="url(#il-rg)" />
            <rect x="0" y="0" width="800" height="450" fill="url(#il-hg)" />
            <line x1="382" y1="0" x2="0"   y2="450" stroke="url(#il-el)" strokeWidth="2.5" />
            <line x1="418" y1="0" x2="800" y2="450" stroke="url(#il-er)" strokeWidth="2.5" />

            <g clipPath="url(#il-rc)">
              {Array.from({ length: 22 }, (_, i) => {
                const p = i / 21;
                const y = p * 450;
                const w = 1.5 + p * 7;
                const h = (5 + p * 26) * 0.55;
                return (
                  <rect
                    key={i}
                    x={400 - w / 2} y={y - h / 2}
                    width={w} height={h} rx="2"
                    fill="#a855f7"
                    opacity={0.1 + p * 0.48}
                    style={{
                      animation: `roadScroll 0.48s linear infinite`,
                      animationDelay: `${-i * 0.022}s`,
                    }}
                  />
                );
              })}
            </g>

            <rect x="0" y="0" width="800" height="240" fill="url(#il-rf)" />
          </svg>

          {/* Horizon glow at vanishing point */}
          <div
            style={{
              position: 'absolute',
              top: '20%', left: '50%',
              width: 220, height: 70,
              borderRadius: '50%',
              background:
                'radial-gradient(ellipse, rgba(138,0,244,0.55) 0%, transparent 70%)',
              filter: 'blur(22px)',
              zIndex: 4, pointerEvents: 'none',
              transform: 'translate(-50%, -50%)',
              animation: 'horizonBreath 2.2s ease-in-out infinite alternate',
            }}
          />
        </>
      )}

      {/* ════════════════════════════════════════
          SVG LOGO — potrace frames
          ────────────────────────────────────────
          FIX: wrapper is centred with translate(-50%,-50%)
               inner <svg> has NO extra transform attribute
          FIX: fill="#9810E8" + fillRule="evenodd"
               → inner sub-paths (m450 etc.) cut holes
               → #4A0971 rect behind shows through holes
          FIX: svgRevealIn only triggers on frame 2 (first appearance)
      ════════════════════════════════════════ */}
      {isSvg && FRAMES[frame] && (
        <div
          style={{
            position: 'absolute',
            top: '30%',
            left: '50%',                                   // ← fixed (was 55%)
            transform: 'translate(-50%, -50%)',            // ← on wrapper only
            zIndex: 40,
            filter: 'drop-shadow(0 0 24px rgba(152,16,232,0.75))',
            // Only animate the first time the logo appears
            animation: frame === 2
              ? 'svgRevealIn 0.4s cubic-bezier(0.34,1.3,0.64,1) forwards'
              : undefined,
          }}
        >
          {/* Dark purple background rect — shows through evenodd holes */}
          <div
            style={{
              position: 'absolute',
              inset: 0,
              background: '#4A0971',
              clipPath: 'inset(0)',
              zIndex: 0,
              borderRadius: 4,
            }}
          />

          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 10800 19200"
            style={{
              width: 160,
              height: 'auto',
              display: 'block',
              position: 'relative',
              zIndex: 1,
              // NO transform here — wrapper handles centering
            }}
          >
            <g
              transform="translate(0,19200) scale(1,-1)"
              fill="#9810E8"
              fillRule="evenodd"
              stroke="none"
            >
              <g dangerouslySetInnerHTML={{ __html: FRAMES[frame] }} />
            </g>
          </svg>
        </div>
      )}

      {/* ════════════════════════════════════════
          VIDEO — plays fullscreen after SVG frames
          FIX: onEnded fires setPhase('fade')
          FIX: road scene unmounted during video (conditional above)
      ════════════════════════════════════════ */}
      {isVideo && (
        <video
          ref={videoRef}
          src={introVideo}
          muted
          playsInline
          preload="auto"
          onEnded={() => setPhase('fade')}         // ← was missing
          style={{
            position: 'absolute',
            top: '50%', left: '50%',
            transform: 'translate(-50%, -50%)',
            width: '100%',
            height: '100%',
            objectFit: 'cover',
            zIndex: 50,
            animation: 'videoRevealIn 0.5s ease forwards',
          }}
        />
      )}
    </div>
  );
}